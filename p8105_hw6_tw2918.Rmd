---
title: "p8105_hw6_tw2918"
output: github_document
date: "2023-11-20"
---

```{r, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(modelr)
set.seed(1)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Probelm 1

**Import and Clean Dataset**

* update the victim's first and last name to proper case
* replace `unknown` to missing value `NA`
* update `victim_age` to numeric variable
* create new variable `city_state` and `case_resovled`, ane make `case_resovled` numeric
* filter out four `city_state` values
* filter and only keep observations if `victim_race` is white or black. 

```{r}
homicide_df = read_csv("./data/homicide_data.csv", show_col_types = FALSE) |>
  janitor::clean_names()|>
  mutate (
    victim_last = str_to_title(victim_last),
    victim_first = str_to_title(victim_first),
    across(c(uid, victim_last, victim_first, victim_race, victim_age, victim_sex, city, state, disposition), ~na_if(., "Unknown")),
    victim_age = as.numeric(victim_age),
    city_state = paste(city, state, sep = ", "),
    case_resolved = ifelse(grepl("Closed", disposition, ignore.case = TRUE), "1", "0"),
    case_resolved = as.numeric(case_resolved)
    )|>
  filter(
    !city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO" ),
    victim_race == "White" | victim_race == "Black"
    )

print(homicide_df)
```

**logistic regression on city of Balitmore, MD**

For the city of `Baltimore, MD`, use the `glm` function to fit a logistic regression with `resolved` vs `unresolved` as the outcome and victim age, sex and race as predictors. Save the output of `glm` as an `R object`; 

```{r}
fit_logistic = homicide_df |>
  filter(city_state == "Baltimore, MD")|>
  glm(case_resolved ~ victim_age + victim_sex + victim_race,data = _, family = binomial())

print(fit_logistic)
```

apply the `broom::tidy` to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.

```{r}
fit_logistic|>
  broom::tidy()|>
  filter(term == "victim_sexMale")|>
  mutate(OR = exp(estimate),
         ci_lower = exp(estimate - (1.96 * std.error)),
         ci_upper = exp(estimate + (1.96 * std.error))
      )|>
  select(term, OR, ci_lower, ci_upper)|>
  knitr::kable(digits = 3)
```

**logistic regression on each of the city**

run `glm` for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. Do this within a “tidy” pipeline, making use of `purrr::map`, `list columns`, and `unnest` as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}
fit_logistic_allcity = homicide_df |>
    nest(df = -city_state)|>
  mutate(
    glm_model = purrr::map(df, \(df) 
                     glm(case_resolved ~ victim_age + victim_sex + victim_race,data =df, family = binomial())),
    glm_result = map (glm_model, broom::tidy)
  )|>
  select(city_state, glm_result)|>
  unnest(glm_result)|>
  filter(term == "victim_sexMale")|>
  mutate(OR = exp(estimate),
         ci_lower = exp(estimate - (1.96 * std.error)),
         ci_upper = exp(estimate + (1.96 * std.error))
      )|>
  select(city_state, OR, ci_lower, ci_upper)

print(fit_logistic_allcity)
```

